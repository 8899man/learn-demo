title: Yarn的安装与详细使用介绍

# 背景
在 Node 生态系统中，依赖通常安装在项目的 `node_modules` 文件夹中。然而，这个文件的结构和实际依赖树可能有所区别，因为重复的依赖可以合并到一起。`npm` 客户端把依赖安装到 `node_modules` 目录的过程具有不确定性。这意味着当依赖的安装顺序不同时，`node_modules` 目录的结构可能会发生变化。这种差异可能会导致类似“我的机子上可以运行，别的机子不行”的情况，并且通常要花费大量时间定位与解决。

[Yarn](https://github.com/yarnpkg/yarn) 一开始的主要目标是解决由于语义版本控制而导致的的 npm 安装的不确定性问题。虽然可以用 `npm shrinkwrap` 来实现可预测的依赖关系树，但它并不是默认选项，而是取决于所有的开发人员知道并启用这个选项。

Lockfile 还使用简洁的有序键名的格式，保证了每次的文件变化最小化，进行代码审查也更为简单。

# 什么是 Yarn
Yarn 就是一个类似于 npm 的包管理工具，它是由 facebook 推出并开源。鉴于 facebook 在前端界影响力，yarn 一面世就很受瞩目，受到了前端界的广泛欢迎。

与 npm 相比，yarn 有着众多的优势，主要的优势在于：速度快、离线模式、版本控制。

## 速度快
npm 会等一个包完全安装完才跳到下一个包，但 yarn 会并行执行包，因此速度会快很多。

Yarn 会缓存它下载的每个包，所以无需重复下载。它还能并行化操作以最大化资源利用率，安装速度之快前所未有。

## 离线模式
之前安装过的包会被保存进缓存目录，以后安装就直接从缓存中复制过来，这样做的本质还是会提高安装下载的速度，避免不必要的网络请求。

## 可靠可确定性
保证各平台依赖的一致性

## 网络优化
力求网络资源最大利用化，让资源下载完美队列执行，避免大量的无用请求，下载失败会自动重新请求，避免整个安装过程失败

## 扁平化模式
对于不匹配的依赖版本的包创立一个独立的包，避免创建重复的。

## 版本控制
npm 用下来比较强的一个痛点就是：当包的依赖层次比较深时，版本控制不够精确。会出现相同 package.json，但不同人的电脑上安装出不同版本的依赖包，出现类似“我电脑上是好的，没问题呀”的 bug 很难查找。你可以使用 [npm-shrinkwrap](https://docs.npmjs.com/cli/shrinkwrap) 来实现版本固化，版本信息会写入 npm-shrinkwrap.json 文件中，但它毕竟不是 npm 的标准配置。

而 yarn 天生就能实现版本固化。会生成一个类似 npm-shrinkwrap.json 的 yarn.lock 文件，而文件内会描述包自身的版本号，还会锁定所有它依赖的包的版本号：
```
"@babel/code-frame@7.0.0-beta.47":
  version "7.0.0-beta.47"
  resolved "https://registry.yarnpkg.com/@babel/code-frame/-/code-frame-7.0.0-beta.47.tgz#d18c2f4c4ba8d093a2bcfab5616593bfe2441a27"
  dependencies:
    "@babel/highlight" "7.0.0-beta.47"
```
yarn.lock 存储着你的每个包的确切依赖版本，能确保从本地开发到生产环境，所有机器上都有精确相同的依赖版本。

## 其他关于 Yarn 的介绍
我们在使用 Yarn 时，依然要访问 npm 仓库，但 Yarn 能够更快速地安装软件包和管理依赖关系，并且可以在跨机器或者无网络的安全环境中保持代码的一致性。Yarn 提高了开发效率，并解决了共享代码时面临的一些问题，使得工程师们可以专注在构建新产品以及新特性上。


# Yarn 安装
在 Yarn 中文网可以找到 window 下的三种安装方法：

/截图/

不过我觉得这三种方法都不好用，快速好用的安装方法应该还是使用 npm 来安装：
```
npm install -g yarn
```

关于为什么使用 `-g`，以及 `-g` 会带来哪来影响，这个可以看我的这篇文章：[npm详细介绍]()，里面详细介绍了为什么要使用 `-g`，以及 `-g` 的作用。

## 安装过程
安装过程分为以下三个步骤：
1、处理：Yarn 通过向代码仓库发送请求，并递归查找每个依赖项，从而解决依赖关系。
2、抓取：接下来，Yarn 会查找全局的缓存目录，检查所需的软件包是否已被下载。如果没有，Yarn 会抓取对应的压缩包，并放置在全局的缓存目录中，因此 Yarn 支持离线安装，同一个安装包不需要下载多次。依赖也可以通过 tarball 的压缩形式放置在源码控制系统中，以支持完整的离线安装。
3、生成：最后，Yarn 从全局缓存中把需要用到的所有文件复制到本地的 `node_modules` 目录中。



# Yarn 换源
Yarn 源仓库包下载不稳定
```
yarn get registry

> https://registry.yarnpkg.com
```
可以设置为 npm 仓库的淘宝镜像
```
yarn config set registry https://registry.npm.taobao.org
```


# 特性
Yarn 除了让安装过程变得更快与更可靠，还添加了一些额外的特性，从而进一步简化依赖管理的工作流。

- 同时兼容 `npm` 与 `bower` 工作流，并支持两种软件仓库混合使用
- 可以限制已安装模块的协议，并提供方法输出协议信息
- 提供一套稳定的共有 JS API，用于记录构建工具的输出信息
- 可读、最小化、美观的 CLI 输出信息





